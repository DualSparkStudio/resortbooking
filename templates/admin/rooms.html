{% extends "admin/base.html" %}

{% block title %}Manage Rooms - Admin Panel{% endblock %}

{% block page_title %}Room Management{% endblock %}

{% block content %}
<!-- Room Types Section -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-bed me-2"></i>Room Types</h6>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addRoomTypeModal">
                <i class="fas fa-plus me-1"></i>Add Room Type
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        {% if room_types %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Name</th>
                            <th>Price/Night</th>
                            <th>Max Occupancy</th>
                            <th>Rooms Available</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for room_type in room_types %}
                        <tr>
                            <td>
                                <div>
                                    <strong>{{ room_type.name }}</strong>
                                    {% if room_type.description %}
                                        <br><small class="text-muted">{{ room_type.description[:50] }}...</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td><strong>{{ format_currency(room_type.price_per_night) }}</strong></td>
                            <td>{{ room_type.max_occupancy }} guests</td>
                            <td>{{ room_type.rooms|length }} rooms</td>
                            <td>
                                {% if room_type.is_active %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editRoomTypeModal{{ room_type.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger"
                                            onclick="confirmDelete('room_type', {{ room_type.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-bed fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">No room types found</h6>
                <p class="text-muted">Add your first room type to get started</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Individual Rooms Section -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-door-open me-2"></i>Individual Rooms</h6>
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addRoomModal">
                <i class="fas fa-plus me-1"></i>Add Room
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        {% if rooms %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Room Number</th>
                            <th>Type</th>
                            <th>Floor</th>
                            <th>Status</th>
                            <th>Current Bookings</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for room in rooms %}
                        <tr>
                            <td><strong>{{ room.room_number }}</strong></td>
                            <td>{{ room.room_type.name }}</td>
                            <td>{{ room.floor or 'N/A' }}</td>
                            <td>
                                {% if room.is_available %}
                                    <span class="badge bg-success">Available</span>
                                {% else %}
                                    <span class="badge bg-warning">Unavailable</span>
                                {% endif %}
                            </td>
                            <td>
                                {% set active_bookings = room.bookings|selectattr('booking_status', 'in', ['confirmed', 'pending'])|list %}
                                {% if active_bookings %}
                                    <span class="badge bg-info">{{ active_bookings|length }} booking(s)</span>
                                {% else %}
                                    <span class="text-muted">No bookings</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editRoomModal{{ room.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger"
                                            onclick="confirmDelete('room', {{ room.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-door-open fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">No rooms found</h6>
                <p class="text-muted">Add individual rooms to your room types</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Room Type Modal -->
<div class="modal fade" id="addRoomTypeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Room Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_rooms') }}">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Room Type Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price per Night ($)</label>
                            <input type="number" class="form-control" name="price_per_night" step="0.01" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Maximum Occupancy</label>
                            <input type="number" class="form-control" name="max_occupancy" min="1" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Image URL</label>
                            <input type="url" class="form-control" name="image_url">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amenities (one per line)</label>
                        <textarea class="form-control" name="amenities" rows="4" 
                                  placeholder="Private balcony&#10;Ocean view&#10;King-size bed&#10;Marble bathroom"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_active" checked>
                        <label class="form-check-label">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Room Type</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Room Modal -->
<div class="modal fade" id="addRoomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_rooms') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Room Number</label>
                        <input type="text" class="form-control" name="room_number" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Room Type</label>
                        <select class="form-select" name="room_type_id" required>
                            <option value="">Select a room type</option>
                            {% for room_type in room_types %}
                            <option value="{{ room_type.id }}">{{ room_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Floor</label>
                        <input type="number" class="form-control" name="floor" min="1">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_available" checked>
                        <label class="form-check-label">Available</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Room</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function confirmDelete(type, id) {
    if (confirm(`Are you sure you want to delete this ${type}? This action cannot be undone.`)) {
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{{ url_for('admin_rooms') }}`;
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = `delete_${type}`;
        
        const idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = `${type}_id`;
        idInput.value = id;
        
        form.appendChild(actionInput);
        form.appendChild(idInput);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
